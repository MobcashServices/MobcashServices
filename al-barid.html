<div class="main-box" style="position:relative; width:90%; max-width:420px; margin:60px auto; background:#fff; border-radius:14px; overflow:visible; box-shadow:0 0 10px rgba(0,0,0,0.2);">

  <a href="home.html" class="exit-button" title="إغلاق" 
     style="position:absolute; top:10px; right:10px; font-size:28px; color:#888; cursor:pointer; font-weight:bold; z-index:10; background:none; padding:0 6px; text-decoration:none; user-select:none; transition:color 0.3s ease;">
    ×
  </a>

  <div class="logo-box" style="text-align:center; padding:20px 10px 10px; perspective:600px;">
    <img src="https://i.ibb.co/xq8PQRZx/albarid-linebet.png" alt="albarid-linebet" 
         style="height:40px; transition: transform 0.3s ease; cursor:pointer; transform-style: preserve-3d; display:inline-block;">
  </div>

  <div class="alert" style="background-color:#1c4729; color:#fff; padding:10px 15px; font-size:14px; text-align:center; line-height:1.5;">
    قبل تقديم الطلب، يرجى تحويل الأموال في غضون <strong>10 دقائق</strong><br>باستخدام معلومات الدفع المحددة أدناه.
  </div>

  <form class="form-content" id="transferForm" style="padding:20px;">
    <div class="info-block" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-size:15px; color:#333;">
      <div class="info-label" style="width:45%; text-align:right;">:رقم الحساب البنكي</div>
      <div class="info-input" style="width:50%; display:flex; align-items:center; gap:6px;">
        <strong class="english-numbers" style="font-feature-settings: 'lnum'; direction:ltr; text-align:left; font-family: Arial, sans-serif;">12727454</strong>
        <span class="copy-icon" onclick="copyText(this, '12727454')" style="cursor:pointer; display:inline-block;">
          <img src="https://cdn-icons-png.flaticon.com/512/60/60990.png" alt="copy" style="height:20px;">
        </span>
        <span class="copied-text" style="color:green; font-size:13px; display:none;">تم النسخ</span>
      </div>
    </div>

    <div class="info-block" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-size:15px; color:#333;">
      <div class="info-label" style="width:45%; text-align:right;">:الاسم الكامل للمستلم</div>
      <div class="info-input" style="width:50%; display:flex; align-items:center; gap:6px;">
        <strong style="font-feature-settings: 'lnum'; direction:ltr; text-align:left; font-family: Arial, sans-serif;">M'hamed rabeh</strong>
        <span class="copy-icon" onclick="copyText(this, 'M\'hamed rabeh')" style="cursor:pointer; display:inline-block;">
          <img src="https://cdn-icons-png.flaticon.com/512/60/60990.png" alt="copy" style="height:20px;">
        </span>
        <span class="copied-text" style="color:green; font-size:13px; display:none;">تم النسخ</span>
      </div>
    </div>

    <div class="info-block" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-size:15px; color:#333;">
      <div class="info-label" style="width:45%; text-align:right;">:المبلغ (الحد الأدنى 100.00 / الحد الأقصى 5,000.00 MAD)</div>
      <div class="info-input" style="width:50%;">
        <input type="number" name="amount" class="english-numbers" min="100" max="5000" placeholder="100.00" required
          style="width:100%; padding:10px; font-size:14px; border:1px solid #ccc; border-radius:6px; -webkit-appearance:none;">
      </div>
    </div>

    <div class="info-block" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-size:15px; color:#333;">
      <div class="info-label" style="width:45%; text-align:right;">:اسمك الكامل</div>
      <div class="info-input" style="width:50%;">
        <input type="text" name="sender_name" required
          style="width:100%; padding:10px; font-size:14px; border:1px solid #ccc; border-radius:6px;">
      </div>
    </div>

    <div class="info-block" style="flex-direction: column; align-items: flex-start; margin-bottom: 15px; font-size: 15px; color:#333;">
      <span style="margin-bottom: 10px;">تنبيه، الرجاء تحميل لقطة شاشة للحوالة المصرفية الناجحة:</span>
      <div class="upload-wrapper" style="display:flex; align-items:center; gap:15px;">
        <img id="preview" class="preview-image" 
             style="width:60px; height:60px; border-radius:6px; object-fit:cover; border:1px solid #ccc; display:none;" />
        <div class="upload-section" style="border:2px dashed #aaa; text-align:center; padding:20px; border-radius:10px; width:100px; height:80px; display:flex; align-items:center; justify-content:center; position:relative;">
          <label for="proof" style="font-size:30px; color:#666; cursor:pointer;">+</label>
          <input type="file" id="proof" name="proof" accept=".jpg,.jpeg,.png" required style="display:none;">
        </div>
      </div>
    </div>

    <div class="note" style="font-size:13px; color:#666; text-align:center; margin-bottom:15px;">
      تحميل الملف .jpg, .jpeg, .png - الحجم الأقصى 20 ميغا بايت
    </div>

    <button type="submit" class="submit-btn" 
            style="background-color:#1c4729; color:#fff; font-size:17px; padding:14px; border:none; width:100%; border-radius:0 0 14px 14px; cursor:pointer; transition: background-color 0.3s ease;">
      التأكيد
    </button>
  </form>
</div>

<input type="text" id="hiddenCopyInput" class="hidden-copy-input" readonly
       style="position:absolute; top:-9999px; left:-9999px;" />

<script>
  function copyText(element, value) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(value).then(() => {
        const message = element.nextElementSibling;
        message.style.display = 'inline';
        setTimeout(() => {
          message.style.display = 'none';
        }, 1200);
      }).catch(() => fallbackCopy(element, value));
    } else {
      fallbackCopy(element, value);
    }
  }

  function fallbackCopy(element, value) {
    const hiddenInput = document.getElementById('hiddenCopyInput');
    hiddenInput.value = value;
    hiddenInput.select();
    document.execCommand('copy');
    const message = element.nextElementSibling;
    message.style.display = 'inline';
    setTimeout(() => {
      message.style.display = 'none';
    }, 1200);
  }

  function resizeImage(file, maxWidth = 800, maxHeight = 800) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width, height = img.height;
        if (width > height) {
          if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width *= maxHeight / height;
            height = maxHeight;
          }
        }
        canvas.width = width;
        canvas.height = height;
        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
        canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.7);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  document.getElementById("transferForm").onsubmit = async function(e) {
    e.preventDefault();
    const form = e.target;
    const amount = form.amount.value;
    const fullname = form.sender_name.value;
    const file = document.getElementById("proof").files[0];
    if (!file) return alert("يرجى تحميل صورة.");

    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'جاري الإرسال...';

    try {
      const compressedBlob = await resizeImage(file);
      const imageBase64 = await blobToBase64(compressedBlob);

      const response = await fetch("https://script.google.com/macros/s/AKfycby_yPgXCCFpvGRQ4Doa1FMfHS4jXd5y8p--fPQAFnADcFI6IcvfPp5WtZjt2GjqXzoneQ/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({ amount, fullname, imageBase64 })
      });

      if (response.ok) {
        window.location.href = "thanks.html";
      } else {
        alert("حدث خطأ أثناء إرسال البيانات.");
      }
    } catch (error) {
      alert("حدث خطأ أثناء معالجة الصورة أو الإرسال.");
      console.error(error);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'التأكيد';
    }
  };

  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  const logoImg = document.querySelector('.logo-box img');
  logoImg.addEventListener('mousedown', () => logoImg.classList.add('active'));
  logoImg.addEventListener('mouseup', () => logoImg.classList.remove('active'));
  logoImg.addEventListener('mouseleave', () => logoImg.classList.remove('active'));
  logoImg.addEventListener('touchstart', () => logoImg.classList.add('active'));
  logoImg.addEventListener('touchend', () => logoImg.classList.remove('active'));

  document.getElementById('proof').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('preview');
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.src = '';
      preview.style.display = 'none';
    }
  });
</script>
